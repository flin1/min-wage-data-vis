<!DOCTYPE html>
<html>
  <head>
    <title>
      US Leading Causes of Death (1999-2017) Narrative Visualization
    </title>
    <meta name="description" content="Overview of death causes" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="d3_annotation.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Abel&family=Roboto+Slab:wght@300&display=swap"
      rel="stylesheet"
    />
  </head>
  <body onload="main()">
    <h2>US Leading Causes of Death (1999-2017) Narrative Visualization</h2>
    <h4>
      Sourced from
      <a
        >https://www.kaggle.com/datasets/adelanseur/leading-causes-of-death-in-the-us-1999-2017</a
      >
    </h4>
    <div id="content">
      <svg></svg>
      <div class="dropdown"></div>
    </div>

    <script>
      async function main() {
        var data = await d3
          .csv("leading.csv")
          .then(function (data) {
            console.log(data);
            return data;
          })
          .catch(function () {
            console.log("data not processed");
          });

        const type = d3.annotationLabel;
        var x = d3
          .scaleTime()
          .domain(
            d3.extent(data, function (d) {
              return new Date(d["Year"]);
            })
          )
          .range([0, 1000]);
        var parseTime = d3.timeParse("%Y");

        var y = d3.scaleLog().domain([10, 10000]).range([600, 0]);

        var svg = d3.select("svg").attr("width", 1200).attr("height", 700);

        var g = svg.append("g").attr("transform", "translate(50,50)");

        // create a tooltip
        var tooltip = d3
          .select("body")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
          .style("width", "200px")
          .style("height", "50px")
          .style("position", "absolute");

        // data
        g.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr("cx", function (d, i) {
            return x(parseTime(d["Year"]));
          })
          .attr("cy", function (d, i) {
            return y(d["Deaths"]);
          })
          .attr("r", function (d) {
            return 4;
          })
          .on("mouseover", function (d, i) {
            tooltip
              .style("opacity", 1)
              .html(
                "STATE: " +
                  d["State"] +
                  " \n" +
                  "DEATHS: " +
                  d["Deaths"] +
                  " \n" +
                  "CAUSE: " +
                  d["Cause Name"] +
                  " \n"
              )
              .style("top", d3.event.pageY + "px")
              .style("left", d3.event.pageX + "px");
          })
          .on("mouseout", function (d, i) {
            tooltip.style("opacity", 0);
          });

        // y axis
        var g2 = svg
          .append("g")
          .attr("transform", "translate(50,50)")
          .call(d3.axisLeft(y))
          .attr("fill", "none")
          .attr("font-size", "10")
          .attr("font-family", "Roboto Slab, serif")
          .attr("text-anchor", "end");

        // x axis
        var g3 = svg
          .append("g")
          .attr("transform", "translate(50,650)")
          .call(d3.axisBottom(x))
          .attr("fill", "none")
          .attr("font-size", "10")
          .attr("font-family", "Roboto Slab, serif")
          .attr("text-anchor", "middle");

        // x axis label
        svg
          .append("text")
          .attr("x", 550)
          .attr("y", 700)
          .style("text-anchor", "middle")
          .text("Year")
          .attr("font-family", "Roboto Slab, serif");

        // y axis label
        svg
          .append("text")
          .attr("text-anchor", "end")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x", -300)
          .attr("dy", ".75em")
          .text("Deaths")
          .attr("font-family", "Roboto Slab, serif");

        // annotations
        const annotations = [
          {
            note: {
              label:
                "Hover on points to get additional details. (click to remove instructions)",
              bgPadding: 20,
              title: "Step 1:",
            },
            //can use x, y directly instead of data
            className: "show-bg",
            color: ["#69b3a2"],
            x: 550,
            y: 400,
            dy: -137,
            dx: -162,
          },
          {
            note: {
              label:
                "Use a dropdown to show just points from a certain cause of death. (click to remove instructions)",
              bgPadding: 20,
              title: "Step 2:",
            },
            //can use x, y directly instead of data
            className: "show-bg",
            color: ["#69b3a2"],
            x: 100,
            y: 700,
            dy: -10,
            dx: 150,
          },
        ];

        const makeAnnotations = d3
          .annotation()
          .editMode(false)
          //also can set and override in the note.padding property
          //of the annotation object
          .notePadding(10)
          .type(type)
          .annotations(annotations);

        d3.select("svg")
          .append("g")
          .attr("class", "annotation-group")
          .call(makeAnnotations);

        d3.select("svg").on("click", function () {
          d3.select(".annotations").remove();
        });

        // dropdown
        var map = d3.map();
        data.forEach(function (d) {
          if (!map.has(d["Cause Name"])) {
            map.set(d["Cause Name"], d["Cause Name"]);
          }
        });
        var dropdown = d3.select(".dropdown").append("select");
        dropdown
          .selectAll("option")
          .data(map.keys())
          .enter()
          .append("option")
          .text(function (d) {
            return d;
          })
          .attr("value", function (d) {
            return d;
          });

        function updateChart(cause) {
          
        }

        d3.select(".dropdown").on("change", function (d) {
          var cause = eval(d3.select(".dropdown").property('value'));
          console.log("info" + cause);
          updateChart(cause);
        });
      }
    </script>
  </body>
</html>
